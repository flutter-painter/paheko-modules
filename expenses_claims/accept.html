{{#restrict section="accounting" level="write" block=true}}{{/restrict}}

{{#load assign="claim" key=$_GET.claim}}
{{else}}
	{{:error message="Cette note de frais n'existe pas"}}
{{/load}}

{{if $claim.status !== 'waiting'}}
	{{:error message="Cette note de frais n'est pas en attente de paiement: %s"|args:$claim.status}}
{{/if}}

{{#form on="save"}}
	{{:assign total=0}}
	{{:assign var="upload_path" value=$claim.key}}

	{{#foreach from=$_POST.lines|array_transpose}}
		{{:assign var="lines." debit=$amount label=$label account=$account|keys|key:0}}
		{{:assign amount=$amount|money_int}}
		{{:assign total="%d+%d"|math:$amount:$total}}
	{{/foreach}}

	{{if !$total}}
		{{:error message="Cette note de frais ne comporte aucune ligne"}}
	{{/if}}

	{{:assign var="lines." credit=$total|money_raw account=$_POST.account_selector|keys|key:0 label="Dette envers le membre"}}
	{{:create entity="transaction"
		assign_new_id="id"
		id_year=$_POST.id_year|intval
		type="advanced"
		date=$_POST.date
		label="Note de frais n°%d (%s)"|args:$claim.number:$claim.user_name
		reference="NDF-%d"|args:$claim.number
		linked_users=$claim.user_id
		lines=$lines
		notes=$_POST.notes|trim|or:null
		move_attachments_from=$upload_path
	}}
	{{:save key=$claim.key status="payable" id_transaction=$id}}
	{{:http redirect="details.html?key=%s"|args:$claim.key}}
{{/form}}

{{:admin_header title="Accepter la note de frais n°%d"|args:$claim.number}}

{{:form_errors}}

<form method="post" action="">
	<fieldset>
		<legend>Écriture de note de frais</legend>
		{{#load type="line" claim=$claim.key}}
			{{:assign var="notes" value="%s\n\n%s"|args:$notes:$description}}
		{{/load}}
		{{:assign var="default_account.4110" value="4110 — Autres usagers"}}
		{{#years closed=false}}
			{{:assign var="open_years.%d"|args:$id value=$label}}
			{{if $start_date <= $now && $end_date >= $now}}
				{{:assign best_year=$id}}
			{{/if}}
		{{/years}}
		<dl>
			{{:input type="select" default=$best_year name="id_year" label="Exercice" required=true options=$open_years}}
			{{:input type="date" default=$now name="date" label="Date" required=true}}
			{{:input type="text" default="Note de frais n°%d"|args:$claim.number name="label" label="Libellé" required=true}}
			{{:input type="list" name="account_selector" label="Compte de tiers" required=true target="!acc/charts/accounts/selector.php?targets=4&key=code" default=$default_account}}
			{{:input type="textarea" name="notes" label="Remarques" default=$notes|trim cols=50 rows=10}}
		</dl>
	</fieldset>

	<fieldset>
		<legend>Lignes de la note de frais</legend>

		<table class="list auto">
			<thead>
				<tr>
					<td>Compte</td>
					<td>Libellé</td>
					<td>Montant</td>
				</tr>
			</thead>
			<tbody>
				{{#load type="line" claim=$claim.key}}
				{{:assign default_account=null}}
				{{:assign var="default_account.%s"|args:$account value=$account}}
				<tr>
					<td>{{:input type="list" name="lines[account][]" required=true target="!acc/charts/accounts/selector.php?targets=5&key=code" default=$default_account}}</td>
					<td>{{:input type="text" name="lines[label][]" default=$label required=true}}</td>
					<td>{{:input type="money" name="lines[amount][]" default=$amount required=true}}</td>
				</tr>
				{{/load}}
			</tbody>
		</table>
	</fieldset>
	<p class="submit">
		{{:button type="submit" shape="right" label="Accepter" name="save" class="main"}}
	</p>
	<p class="help">
		La note de frais sera transformée en écriture comptable. Les fichiers joints seront déplacés dans l'écriture.
	</p>
</form>

{{:admin_footer}}
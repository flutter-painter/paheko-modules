{{:admin_header title="Notes de frais"}}

<nav class="tabs">
	<aside>
		{{:linkbutton href="new.html" label="Nouvelle note de frais" shape="plus" target="_dialog"}}
	</aside>

	{{#restrict section="accounting" level="write"}}
	<ul>
		<li{{if $_GET.status === 'all'}} class="current"{{/if}}><a href="./?status=all">Toutes les notes de frais</a></li>
		<li{{if $_GET.status === 'waiting'}} class="current"{{/if}}><a href="./?status=waiting">À accepter</a></li>
		<li{{if $_GET.status === 'payable'}} class="current"{{/if}}><a href="./?status=payable">À payer</a></li>
		<li{{if $_GET.status === 'paid'}} class="current"{{/if}}><a href="./?status=paid">Payées</a></li>
		<li{{if $_GET.status === 'cancelled'}} class="current"{{/if}}><a href="./?status=cancelled">Annulées</a></li>
		<li{{if $_GET.status === 'draft'}} class="current"{{/if}}><a href="./?status=draft">Brouillons</a></li>
		<li{{if !$_GET.status}} class="current"{{/if}}><a href="./">Mes notes de frais</a></li>
	</ul>
	{{/restrict}}
</nav>

{{:assign where="$$.user_id = %d"|args:$logged_user.id}}

{{#restrict section="accounting" level="write"}}
	{{if $_GET.status === 'all'}}
		{{:assign where="1"}}
	{{elseif $_GET.status}}
		{{:assign status=$_GET.status|quote_sql}}
		{{:assign where="$$.status = %s"|args:$status}}
	{{/if}}
{{/restrict}}

{{#list
	select="$$.number AS 'Numéro'; $$.user_name AS 'Membre'; $$.date AS 'Date'; CASE $$.status WHEN 'waiting' THEN 'À accepter' WHEN 'payable' THEN 'À payer' WHEN 'paid' THEN 'Payée' WHEN 'cancelled' THEN 'Annulée' ELSE 'Brouillon' END AS 'Statut'"|args:$config.user_fields.name_sql
	order=1
	desc=true
	where="$$.type = 'claim' AND %s"|args:$where
}}
	<tr class="{{if $status === 'cancelled'}}disabled crossed{{/if}}">
		<td class="num">{{:link href="details.html?key=%s"|args:$key label=$number}}</td>
		<td>{{$col2}}</td>
		<td>{{$date|date_short}}</td>
		<td>{{$col4}}</td>
		<td class="actions">
			{{:linkbutton href="details.html?key=%s"|args:$key label="Ouvrir" shape="menu"}}
		</td>
	</tr>
{{else}}
	<p class="alert block">
		Aucune note de frais ici.
	</p>
{{/list}}

{{:admin_footer}}

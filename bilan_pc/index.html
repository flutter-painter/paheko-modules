{{:assign y1=5 y2=4}}
{{*
	Bilan comptable à la française. Oui c'est un peu le bordel !

	Inspiré en partie de Odoo :
	https://github.com/OCA/l10n-france/blob/14.0/l10n_fr_mis_reports/data/mis_report_pl.xml

	https://github.com/OCA/l10n-france/blob/14.0/l10n_fr_mis_reports/data/mis_report_bs.xml

	https://readthedocs.org/projects/oca-mis-builder/downloads/pdf/9.0/

	https://www.plancomptable.com/titre-IV/titre-IV_chapitre-III_section-2.htm

	Exemple : https://www.actioncontrelafaim.org/wp-content/uploads/2017/12/rapport_financier_2016_vdef.pdf

	Mais sauf que bon ben ça n'existe pas pour le plan comptable associatif.
*}}
<!DOCTYPE html>
<html>
<head>
	<style type="text/css">
	table {
		border-collapse: collapse;
		width: 100%;
		border: 1px solid #000;
		margin-bottom: 1em;
		page-break-inside: avoid;
	}
	table th, table td {
		padding: .2em .5em;
		border-left: 1px solid #000;
		border-right: 1px solid #000;
	}
	table thead th, table tfoot th, table thead td, table tfoot td {
		border: 1px solid #000;
	}
	table thead {
		background: #ccc;
		text-align: center;
		font-weight: bold;
	}
	table tbody th, b.money {
		font-weight: normal;
		text-align: left;
	}
	table tbody td {
		width: 15%;
		text-align: center;
	}

	table tbody .level2 th {
		padding-left: 2em;
	}

	.total th, .total td, .total b.money {
		font-weight: bold;
	}

	.total {
		border-top: 1px solid #000;
		border-bottom: 1px solid #000;
	}

	.italic {
		font-style: italic;
	}
	</style>
</head>

<body>

<table>
	<thead>
		<tr>
			<th rowspan="2">ACTIF</th>
			<td colspan="3">Exercice N</td>
			<td>Exercice N-1</td>
		</tr>
		<tr>
			<td>Brut</td>
			<td>Amortissement et dépréciations (à déduire)</td>
			<td>Net</td>
			<td>Net</td>
		</tr>
	</thead>
	<tbody>
	{{:assign tsum1=0 tsum2=0 tsum3=0 tsum4=0}}
	{{:assign sum1=0 sum2=0 sum3=0 sum4=0}}
	{{:load_json file="./comptes_bilan.json" assign="bilan"}}
	{{#foreach from=$bilan key="label" item="accounts"}}

		{{:assign c1=null c2=null c3=null c4=null}}

		<tr class="{{if $accounts.2}}{{$accounts.2}}{{elseif $accounts}}level2{{/if}}">
			<th>{{$label}}</th>

		{{if $accounts.0 == 'SUM_ALL'}}
			<td>{{$tsum1|raw|money}}</td>
			<td>{{$tsum2|raw|money}}</td>
			<td>{{$tsum3|raw|money}}</td>
			<td>{{$tsum4|raw|money}}</td>
		{{elseif $accounts.0 == 'SUM'}}
			<td>{{$sum1|raw|money}}</td>
			<td>{{$sum2|raw|money}}</td>
			<td>{{$sum3|raw|money}}</td>
			<td>{{$sum4|raw|money}}</td>
			{{:assign sum1=0 sum2=0 sum3=0 sum4=0}}
		{{elseif !$accounts}}
			<td></td>
			<td></td>
			<td></td>
			<td></td>
		{{else}}
			{{#balances codes=$accounts.0 year=$y1 assign="c1"}}{{/balances}}
			{{#balances codes=$accounts.1 year=$y1 assign="c2"}}{{/balances}}
			{{:assign c3="%d-%d"|math:$c1.balance:$c2.balance}}
			{{#balances codes="%s,%s"|args:$accounts.0:$accounts.1 year=$y2 assign="c4"}}{{/balances}}

			{{:assign
				sum1="%d+%d"|math:$sum1:$c1.balance
				sum2="%d+%d"|math:$sum2:$c2.balance
				sum3="%d+%d"|math:$sum3:$c3
				sum4="%d+%d"|math:$sum2:$c4.balance
				tsum1="%d+%d"|math:$tsum1:$c1.balance
				tsum2="%d+%d"|math:$tsum2:$c2.balance
				tsum3="%d+%d"|math:$tsum3:$c3
				tsum4="%d+%d"|math:$tsum2:$c4.balance
			}}

			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
			<td>{{$c3|raw|money}}</td>
			<td>{{$c4.balance|raw|money}}</td>
		{{/if}}

		</tr>

	{{/foreach}}
	</tbody>
</table>


<table>
	<thead>
		<tr>
			<th>PASSIF</th>
			<td>Exercice N</td>
			<td>Exercice N-1</td>
		</tr>
	</thead>
	<tbody>
		<tr>
			<th>FONDS PROPRES</th>
			<td></td>
			<td></td>
		</tr>
	{{:assign parent=null}}
	{{#balances
		codes="10%,11%,12%,13%,14%"
		where="(id_year = %d OR id_year = %d)"|args:$y1:$y2
		group="SUBSTR(code, 1, 3)"
		order="code"}}
		{{if $parent !== $code|substr:0:2}}
			{{#balances
				select="label, code"
				limit=1
				codes=$code|substr:0:2}}
				{{:assign parent=$code}}
				<tr>
					<th>{{$label}}</th>
					<td></td>
					<td></td>
				</tr>
			{{/balances}}
		{{/if}}

		{{#balances codes="%s%%"|args:$code year=$y1 assign="c1"}}{{/balances}}
		{{#balances codes="%s%%"|args:$code year=$y2 assign="c2"}}{{/balances}}
		<tr class="level2">
			<th>{{$label}}</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>
	{{/balances}}
		<tr class="total">
			<th>Total I</th>
			<td>
				{{#balances codes="10%,11%,12%,13%,14%" year=$y1 assign="t11"}}{{$balance|raw|money}}{{/balances}}
			</td>
			<td>
				{{#balances codes="10%,11%,12%,13%,14%" year=$y2 assign="t12"}}{{$balance|raw|money}}{{/balances}}
			</td>
		</tr>

		<tr>
			<th>FONDS REPORTES ET DEDIES</th>
			<td></td>
			<td></td>
		</tr>
		<tr class="italic">
			<th>Fonds reportés liés aux legs ou donations</th>
			<td>
				{{#balances codes="191%" year=$y1}}{{$balance|raw|money}}{{/balances}}
			</td>
			<td>
				{{#balances codes="191%" year=$y2}}{{$balance|raw|money}}{{/balances}}
			</td>
		</tr>
		<tr class="italic">
			<th>Fonds dédiés</th>
			<td>
				{{#balances codes="19%" where="code NOT LIKE '191%'" year=$y1}}{{$balance|raw|money}}{{/balances}}
			</td>
			<td>
				{{#balances codes="19%" where="code NOT LIKE '191%'" year=$y2}}{{$balance|raw|money}}{{/balances}}
			</td>
		</tr>
		<tr class="total">
			<th>Total II</th>
			<td>
				{{#balances codes="19%" year=$y1 assign="t21"}}{{$balance|raw|money}}{{/balances}}
			</td>
			<td>
				{{#balances codes="19%" year=$y2 assign="t22"}}{{$balance|raw|money}}{{/balances}}
			</td>
		</tr>

		<tr>
			<th>PROVISIONS</th>
			<td></td>
			<td></td>
		</tr>
	{{:assign parent=null}}
	{{#balances
		codes="15%"
		where="(id_year = %d OR id_year = %d)"|args:$y1:$y2
		group="SUBSTR(code, 1, 3)"
		order="code"}}
		{{if $parent !== $code|substr:0:2}}
			{{#balances
				select="label, code"
				limit=1
				codes=$code|substr:0:2}}
				{{:assign parent=$code}}
				<tr>
					<th>{{$label}}</th>
					<td></td>
					<td></td>
				</tr>
			{{/balances}}
		{{/if}}

		{{#balances codes="%s%%"|args:$code year=$y1 assign="c1"}}{{/balances}}
		{{#balances codes="%s%%"|args:$code year=$y2 assign="c2"}}{{/balances}}
		<tr class="level2">
			<th>{{$label}}</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>
	{{/balances}}

		<tr class="total">
			<th>Total III</th>
			<td>
				{{#balances codes="15%" year=$y1 assign="t31"}}{{$balance|raw|money}}{{/balances}}
			</td>
			<td>
				{{#balances codes="15%" year=$y2 assign="t32"}}{{$balance|raw|money}}{{/balances}}
			</td>
		</tr>

		<tr>
			<th>DETTES</th>
			<td></td>
			<td></td>
		</tr>
	{{:assign parent=null t41=0 t42=0}}
	{{#balances
		codes="16%"
		where="(id_year = %d OR id_year = %d)"|args:$y1:$y2
		group="SUBSTR(code, 1, 3)"
		order="code"}}
		{{if $parent !== $code|substr:0:2}}
			{{#balances
				select="label, code"
				limit=1
				codes=$code|substr:0:2}}
				{{:assign parent=$code}}
				<tr>
					<th>{{$label}}</th>
					<td></td>
					<td></td>
				</tr>
			{{/balances}}
		{{/if}}

		{{#balances codes="%s%%"|args:$code year=$y1 assign="c1"}}{{/balances}}
		{{#balances codes="%s%%"|args:$code year=$y2 assign="c2"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>{{$label}}</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>
	{{/balances}}

		{{#balances codes="40%" year=$y1 assign="c1" where="code NOT LIKE '404%' AND code NOT LIKE '405%' AND balance > 0"}}{{/balances}}
		{{#balances codes="40%" year=$y2 assign="c2" where="code NOT LIKE '404%' AND code NOT LIKE '405%' AND balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Dettes Fournisseurs et Comptes rattachés</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>

		{{#balances codes="466%" year=$y1 assign="c1" where="balance > 0"}}{{/balances}}
		{{#balances codes="466%" year=$y2 assign="c2" where="balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Dettes des legs ou donations</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>

		{{#balances codes="43%,44%" year=$y1 assign="c1" where="code NOT LIKE '4487%' AND balance > 0"}}{{/balances}}
		{{#balances codes="43%,44%" year=$y2 assign="c2" where="code NOT LIKE '4487%' AND balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Dettes fiscales et sociales</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>


		{{#balances codes="404%,405%" year=$y1 assign="c1" where="balance > 0"}}{{/balances}}
		{{#balances codes="404%,405%" year=$y2 assign="c2" where="balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Dettes sur immobilisations et comptes rattachés</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>

		{{#balances codes="41%,42%,45%,405%,4672%,4686%" year=$y1 assign="c1" where="balance > 0"}}{{/balances}}
		{{#balances codes="41%,42%,45%,405%,4672%,4686%" year=$y2 assign="c2" where="balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Autres dettes</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>

		{{* Instruments de trésorerie (52XX) ne concerne pas les associations ? *}}

		{{#balances codes="487%" year=$y1 assign="c1" where="balance > 0"}}{{/balances}}
		{{#balances codes="487%" year=$y2 assign="c2" where="balance > 0"}}{{/balances}}
		{{:assign t41="%d+%d"|math:$t41:$c1.balance}}
		{{:assign t42="%d+%d"|math:$t42:$c2.balance}}
		<tr class="level2">
			<th>Produits constatés d’avance</th>
			<td>{{$c1.balance|raw|money}}</td>
			<td>{{$c2.balance|raw|money}}</td>
		</tr>

		<tr class="total">
			<th>Total IV</th>
			<td>
				{{$t41|raw|money}}
			</td>
			<td>
				{{$t42|raw|money}}
			</td>
		</tr>

		<tr>
			<th>Ecarts de conversion Passif (V)</th>
			<td></td>
			<td></td>
		</tr>

		<tr class="total">
			<th>TOTAL GÉNÉRAL (I + II + III + IV + V)</th>
			<td>{{"%d+%d+%d"|math:$t11.balance:$t21.balance:$t31.balance:$t41.balance|raw|money}}</td>
			<td>{{"%d+%d+%d"|math:$t12.balance:$t22.balance:$t32.balance:$t42.balance|raw|money}}</td>
		</tr>
	</tbody>
</table>

{{#foreach from=$csv}}
<tr>
<th>{{$value.0}}</th>
<td>{{#balances codes=$value.1 year=$n}}{{$balance|raw|money}}{{/balances}}</td>
<td>{{#balances codes=$value.2 year=$n}}{{$balance|raw|money}}{{/balances}}</td>
<td>{{#balances codes=$value.3 year=$n}}{{$balance|raw|money}}{{/balances}}</td>
<td>{{#balances codes=$value.4 year=$n1}}{{$balance|raw|money}}{{/balances}}</td>
</tr>
{{/foreach}}

</body>
</html>
